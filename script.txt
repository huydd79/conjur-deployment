#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 26, 2025
# Description: Global environment configuration.

# --- Configuration Status ---
READY=true

# --- Container Environment Setting ---
SUDO=
CONTAINER_MGR=podman

# --- Conjur Network Configuration ---
CONJUR_IP=172.16.100.62
CONJUR_DOMAIN=poc.local
CONJUR_HTTPS_PORT=443

# --- Conjur Identity & Access Management ---
CONJUR_ADMIN_PW="ChangeMe123!!" 
CONJUR_ACCOUNT=POC 

# --- Versioning and Image Paths ---
UPLOAD_DIR=/opt/upload
CONJUR_APPLIANCE_FILE=conjur-appliance-Rls-v13.7.0.tar.gz
CONJUR_VERSION=13.7.0

# --- Node Role Configuration ---
NODE_TYPE="primary" # "primary" or "standby"
NODE_NAME=cjl100062

# --- Cluster Nodes Configuration ---
PRIMARY_NODE=cjl100062
PRIMARY_IP=172.16.100.62
STANDBY_NODES=("cjl100063" "cjl100064")
STANDBY_IPS=("172.16.100.63" "172.16.100.64")

# --- Configuration Header ---
# --- ANSI Color Codes for Professional Output ---
BLUE='\033[0;34m'; GREEN='\033[0;32m'; RED='\033[0;31m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'
echo -e "${CYAN}========================================================${NC}"
echo -e "${CYAN}      CyberArk Secrets Manager - Self-Hosted v${CONJUR_VERSION}${NC}"
echo -e "${CYAN}      Author: Huy Do (huy.do@cyberark.com)${NC}"
echo -e "${CYAN}========================================================${NC}"
echo -e "${BLUE}[INFO]${NC} Node Name    : ${NODE_NAME}"
if [[ "$NODE_TYPE" == "primary" ]]; then
    echo -e "${BLUE}[INFO]${NC} Standby Nodes : ${STANDBY_NODES[*]}"
fi FILE 00.config.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 26, 2025
# Description: Global environment configuration.

# --- Configuration Status ---
READY=true

# --- Container Environment Setting ---
SUDO=
CONTAINER_MGR=podman

# --- Conjur Network Configuration ---
CONJUR_DOMAIN=poc.local
CONJUR_HTTPS_PORT=443

# --- Node Role Configuration ---
NODE_TYPE="primary" # "primary" or "standby"
NODE_NAME=cjl100062

# --- Cluster Nodes Configuration ---
PRIMARY_NODE=cjl100062
PRIMARY_IP=172.16.100.62
STANDBY_NODES=("cjl100063" "cjl100064")
STANDBY_IPS=("172.16.100.63" "172.16.100.64")

# --- Conjur Identity & Access Management ---
CONJUR_ADMIN_PW="ChangeMe123!!" 
CONJUR_ACCOUNT=POC 

# --- Versioning and Image Paths ---
UPLOAD_DIR=/opt/upload
CONJUR_APPLIANCE_FILE=conjur-appliance-Rls-v13.7.0.tar.gz
CONJUR_VERSION=13.7.0

# --- Configuration Header ---
# --- ANSI Color Codes for Professional Output ---
BLUE='\033[0;34m'; GREEN='\033[0;32m'; RED='\033[0;31m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'
echo -e "${CYAN}========================================================${NC}"
echo -e "${CYAN}      CyberArk Secrets Manager - Self-Hosted v${CONJUR_VERSION}${NC}"
echo -e "${CYAN}      Author: Huy Do (huy.do@cyberark.com)${NC}"
echo -e "${CYAN}========================================================${NC}"
echo -e "${BLUE}[INFO]${NC} Node Name    : ${NODE_NAME}"
if [[ "$NODE_TYPE" == "primary" ]]; then
    echo -e "${BLUE}[INFO]${NC} Standby Nodes : ${STANDBY_NODES[*]}"
fi---
FILE 01.check.environment.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Full environment readiness, dependency installation, and Smart Host Sync.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready in 00.config.sh. Set READY=true.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 01: Full Environment & Host Readiness Check ---${NC}"

# --- 1. Check Required Conjur Image File ---
FULL_IMAGE_PATH="${UPLOAD_DIR}/${CONJUR_APPLIANCE_FILE}"
echo -ne "${CYAN}[CHECK]${NC} Checking for Conjur image file... "

if [ -f "$FULL_IMAGE_PATH" ]; then
    echo -e "${GREEN}Found${NC}"
else
    echo -e "${RED}Not Found${NC}"
    echo -e "${YELLOW}[TIP] Please upload ${CONJUR_APPLIANCE_FILE} to ${UPLOAD_DIR}${NC}"
    exit 1
fi

# --- 2. OS Detection and Package Manager Setup ---
if [ -x "$(command -v dnf)" ]; then
    PKG_MANAGER="dnf"
    INSTALL_CMD="dnf install -y"
    # Enable EPEL for RHEL-based systems (required for 'pv')
    if [ -f /etc/redhat-release ]; then
        echo -e "${BLUE}[INFO]${NC} RHEL system detected. Ensuring EPEL repository is enabled..."
        $SUDO $INSTALL_CMD https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E %rhel).noarch.rpm &> /dev/null
    fi
elif [ -x "$(command -v apt-get)" ]; then
    PKG_MANAGER="apt-get"
    INSTALL_CMD="apt-get install -y"
else
    echo -e "${RED}[ERROR] No supported package manager (dnf/apt) found.${NC}"
    exit 1
fi

# --- 3. Define and Install Required Packages ---
REQUIRED_PKGS=("jq" "curl" "openssl" "ca-certificates" "pv")

for PKG in "${REQUIRED_PKGS[@]}"; do
    echo -ne "${CYAN}[CHECK]${NC} Checking for ${PKG}... "
    if command -v "$PKG" &> /dev/null; then
        echo -e "${GREEN}Installed${NC}"
    else
        echo -e "${YELLOW}Missing. Installing...${NC}"
        $SUDO $INSTALL_CMD "$PKG" &> /dev/null
        if [ $? -ne 0 ]; then
            echo -e "${RED}[ERROR] Failed to install ${PKG}.${NC}"
            exit 1
        fi
    fi
done

# --- 4. Container Manager Check & Installation ---
echo -ne "${CYAN}[CHECK]${NC} Checking for ${CONTAINER_MGR}... "
if command -v "$CONTAINER_MGR" &> /dev/null; then
    echo -e "${GREEN}Found${NC}"
else
    echo -e "${YELLOW}Not Found. Attempting to install ${CONTAINER_MGR}...${NC}"
    if [[ "$CONTAINER_MGR" == "podman" ]]; then
        $SUDO $INSTALL_CMD podman &> /dev/null
    elif [[ "$CONTAINER_MGR" == "docker" ]]; then
        [[ "$PKG_MANAGER" == "apt-get" ]] && $SUDO $INSTALL_CMD docker.io &> /dev/null || $SUDO $INSTALL_CMD docker &> /dev/null
    fi
    
    if command -v "$CONTAINER_MGR" &> /dev/null; then
        echo -e "${GREEN}[SUCCESS] ${CONTAINER_MGR} installed.${NC}"
    else
        echo -e "${RED}[ERROR] Failed to install ${CONTAINER_MGR}.${NC}"
        exit 1
    fi
fi

# --- 5. SMART HOST UPDATE LOGIC ---
echo -e "${CYAN}[PROCESS]${NC} Synchronizing /etc/hosts with cluster configuration..."

# Helper Function: add_or_update_host_entry <IP> <HOSTNAME>
add_or_update_host_entry() {
    local IP=$1
    local NAME=$2
    local FQDN="${NAME}.${CONJUR_DOMAIN}"
    local NEW_ENTRY="${IP}  ${NAME}  ${FQDN}"
    
    # Check if the EXACT line already exists
    if grep -Fxq "$NEW_ENTRY" /etc/hosts; then
        echo -e "${GREEN}[OK]${NC} Host entry for ${FQDN} is already correct."
    else
        # If the FQDN exists but with different data, remove it
        if grep -q "$FQDN" /etc/hosts; then
            echo -e "${YELLOW}[UPDATE]${NC} Outdated or incorrect entry found for ${FQDN}. Updating..."
            $SUDO sed -i "/$FQDN/d" /etc/hosts
        else
            echo -e "${BLUE}[INFO]${NC} Adding new entry for ${FQDN}..."
        fi
        
        # Append the new correct entry
        echo "$NEW_ENTRY" | $SUDO tee -a /etc/hosts > /dev/null
    fi
}

# 5.1 Sync Primary Node
if [ -n "$PRIMARY_IP" ] && [ -n "$PRIMARY_NODE" ]; then
    add_or_update_host_entry "$PRIMARY_IP" "$PRIMARY_NODE"
else
    echo -e "${RED}[ERROR] PRIMARY_IP or PRIMARY_NODE is undefined in 00.config.sh${NC}"
    exit 1
fi

# 5.2 Sync Standby Nodes from Array
for i in "${!STANDBY_NODES[@]}"; do
    S_NAME="${STANDBY_NODES[$i]}"
    S_IP="${STANDBY_IPS[$i]}"
    if [ -n "$S_IP" ] && [ -n "$S_NAME" ]; then
        add_or_update_host_entry "$S_IP" "$S_NAME"
    fi
done

# --- Final Verification ---
echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN}  Step 01 Finished: Env, Software, and Hosts are READY. ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 02.load.conjur.image.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 26, 2025

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 02: Load Conjur Image with Progress Bar ---${NC}"

FULL_IMAGE_PATH="${UPLOAD_DIR}/${CONJUR_APPLIANCE_FILE}"

# --- Check if pv is installed ---
if ! command -v pv &> /dev/null; then
    echo -e "${YELLOW}[WARN] 'pv' not found. Loading without progress bar...${NC}"
    $SUDO $CONTAINER_MGR load -i "$FULL_IMAGE_PATH"
else
    echo -e "${BLUE}[INFO] Loading Conjur appliance image...${NC}"
    pv "$FULL_IMAGE_PATH" | $SUDO $CONTAINER_MGR load
fi

# --- Verification ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Conjur image loaded successfully.${NC}"
else
    echo -e "${RED}[ERROR] Failed to load the image.${NC}"
    exit 1
fi

$SUDO $CONTAINER_MGR images | grep -i "conjur"---
FILE 03.start.conjur.container.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Unified script to start Conjur Appliance for both Primary and Standby.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 03: Initialize Unified Conjur Appliance Container ---${NC}"
echo -e "${BLUE}[INFO]${NC} Deploying as: ${NODE_TYPE}"

# --- Step 1: Auto-Detect Correct Image Name ---
echo -ne "${CYAN}[CHECK]${NC} Detecting Conjur image for version ${CONJUR_VERSION}... "
DETECTED_IMAGE=$($SUDO $CONTAINER_MGR images --format "{{.Repository}}:{{.Tag}}" | grep ":${CONJUR_VERSION}" | cut -d':' -f1 | head -n1)

if [ -z "$DETECTED_IMAGE" ]; then
    echo -e "${RED}Not Found!${NC}"
    exit 1
else
    FULL_IMAGE_TAG="${DETECTED_IMAGE}:${CONJUR_VERSION}"
    echo -e "${GREEN}Found: ${FULL_IMAGE_TAG}${NC}"
fi

# --- Step 2: Cleanup Existing Container ---
echo -e "${BLUE}[INFO] Cleaning up existing container: ${NODE_NAME}...${NC}"
$SUDO $CONTAINER_MGR stop "$NODE_NAME" &> /dev/null
$SUDO $CONTAINER_MGR rm -f "$NODE_NAME" &> /dev/null

# --- Step 3: Prepare Node-Specific Host Directories ---
# Using identical structure for all nodes to support promotion
NODE_DATA_DIR="/opt/cyberark/$NODE_NAME"
echo -e "${BLUE}[INFO] Preparing persistent volumes in ${NODE_DATA_DIR}...${NC}"

$SUDO mkdir -p "${NODE_DATA_DIR}"/{security,config,backups,seeds,logs,certs}
$SUDO chmod o+x "${NODE_DATA_DIR}/config"

# --- Step 4: Execute Container Run (Unified Ports) ---
# We map ALL ports (including 1999) on all nodes so Standbys are ready for promotion.
echo -e "${BLUE}[INFO] Starting Conjur container...${NC}"

$SUDO $CONTAINER_MGR run \
    --name "$NODE_NAME" \
    --detach \
    --restart=unless-stopped \
    --security-opt seccomp=unconfined \
    --publish "$CONJUR_HTTPS_PORT:443" \
    --publish "444:444" \
    --publish "5432:5432" \
    --publish "1999:1999" \
    --cap-add AUDIT_WRITE \
    --volume "${NODE_DATA_DIR}/config:/etc/conjur/config:Z" \
    --volume "${NODE_DATA_DIR}/security:/opt/cyberark/conjur/security:Z" \
    --volume "${NODE_DATA_DIR}/backups:/opt/conjur/backup:Z" \
    --volume "${NODE_DATA_DIR}/seeds:/opt/cyberark/conjur/seeds:Z" \
    --volume "${NODE_DATA_DIR}/logs:/var/log/conjur:Z" \
    --volume "${NODE_DATA_DIR}/certs:/opt/cyberark/conjur/certs:Z" \
    "$FULL_IMAGE_TAG"

# --- Step 5: Final Verification ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Conjur container '${NODE_NAME}' is running.${NC}"
    echo -e "${BLUE}[INFO] Node is ready for 'evoke configure leader' OR 'evoke unpack seed'.${NC}"
else
    echo -e "${RED}[ERROR] Failed to start Conjur container.${NC}"
    exit 1
fi

echo -e "${CYAN}--- Container Status ---${NC}"
$SUDO $CONTAINER_MGR ps | grep "$NODE_NAME"---
FILE 04.config.conjur.leader.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Configure Conjur Leader. Includes Primary-only check.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

# --- Check if Configuration is Ready ---
if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready. Set READY=true in 00.config.sh${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 04: Configure Conjur Leader ---${NC}"

# --- Step 1: Guard Clause - Check if Node is Primary ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This node is configured as '${NODE_TYPE}'.${NC}"
    echo -e "${RED}[ERROR] Script 04 MUST only be executed on the PRIMARY (Leader) node.${NC}"
    echo -e "${YELLOW}[TIP] Standby nodes do not run this. They join via another script.${NC}"
    exit 1
fi

echo -e "${GREEN}[PROCEED] Node is confirmed as PRIMARY. Starting configuration...${NC}"

# --- Step 2: Prepare Configuration Variables ---
LEADER_CONTAINER=$NODE_NAME
CLUSTER_DNS="conjur-leader.${CONJUR_DOMAIN}" 
NODE_FQDN="${NODE_NAME}.${CONJUR_DOMAIN}"    

echo -e "${BLUE}[INFO]${NC} Leader Container : ${LEADER_CONTAINER}"
echo -e "${BLUE}[INFO]${NC} Cluster DNS      : ${CLUSTER_DNS}"
echo -e "${BLUE}[INFO]${NC} Node FQDN         : ${NODE_FQDN}"

# --- Step 3: Execute Evoke Configure Leader ---
echo -e "${BLUE}[INFO] Running 'evoke configure leader' inside container...${NC}"

$SUDO $CONTAINER_MGR exec "$LEADER_CONTAINER" evoke configure leader \
    --accept-eula \
    --hostname "$CLUSTER_DNS" \
    --leader-altnames "${CLUSTER_DNS},${NODE_FQDN}" \
    --admin-password "$CONJUR_ADMIN_PW" \
    "$CONJUR_ACCOUNT"

# --- Step 4: Verification ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Conjur Leader has been configured successfully.${NC}"
else
    echo -e "${RED}[ERROR] Configuration failed. Check container logs.${NC}"
    exit 1
fi

# --- Step 5: Final Health Check ---
echo -e "${CYAN}--- Verifying Leader Health Endpoint ---${NC}"
sleep 5
curl -k -s "https://localhost:$CONJUR_HTTPS_PORT/health" | jq || echo -e "${YELLOW}[WARN] Could not reach health endpoint yet.${NC}"

echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN}  Step 04 Finished: Leader is ready for usage.          ${NC}"
echo -e "${YELLOW}  Web UI: https://${CLUSTER_DNS}:${CONJUR_HTTPS_PORT}/ui ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 05.import.3rd.cert.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Import 3rd Party Certificates. Includes Primary-only check.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

# --- Check if Configuration is Ready ---
if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready. Set READY=true in 00.config.sh${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 05: Import 3rd Party Certificates ---${NC}"

# --- Step 1: Guard Clause - Check if Node is Primary ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This node is configured as '${NODE_TYPE}'.${NC}"
    echo -e "${RED}[ERROR] Script 05 MUST only be executed on the PRIMARY (Leader) node.${NC}"
    echo -e "${YELLOW}[TIP] Standbys inherit certificates via the Seed file from the Leader.${NC}"
    exit 1
fi

echo -e "${GREEN}[PROCEED] Node is confirmed as PRIMARY. Starting certificate import...${NC}"

# --- Step 2: Define Paths & Targets ---
LOCAL_CERT_DIR="./certs"
CA_CHAIN="ca-chain.pem"
MASTER_KEY="master-key.pem"
MASTER_CERT="master-cert.pem"

NODE_DATA_DIR="/opt/cyberark/$NODE_NAME"
NODE_CERT_DIR="${NODE_DATA_DIR}/certs"
CONTAINER_CERT_DIR="/opt/cyberark/conjur/certs"

# Target Hostname calculation
TARGET_HOSTNAME="conjur-leader.${CONJUR_DOMAIN}"

# --- Step 3: File Existence Check ---
for FILE in "$CA_CHAIN" "$MASTER_KEY" "$MASTER_CERT"; do
    if [ ! -f "${LOCAL_CERT_DIR}/$FILE" ]; then
        echo -e "${RED}[ERROR] File not found in local directory: ${LOCAL_CERT_DIR}/$FILE${NC}"
        exit 1
    fi
done

# --- Step 4: Smart Wildcard Validation Logic ---
echo -e "${BLUE}[INFO] Validating if cert covers: ${TARGET_HOSTNAME}...${NC}"
CERT_DNS_LIST=$(openssl x509 -in "${LOCAL_CERT_DIR}/${MASTER_CERT}" -text -noout | grep -oP 'DNS:[^, ]+' | sed 's/DNS://g')
CERT_CN=$(openssl x509 -in "${LOCAL_CERT_DIR}/${MASTER_CERT}" -noout -subject | sed -n 's/.*CN[ ]*=[ ]*\([^,]*\).*/\1/p')

ALL_ENTRIES="$CERT_CN $CERT_DNS_LIST"
IS_VALID=false

for ENTRY in $ALL_ENTRIES; do
    if [[ "$ENTRY" == "$TARGET_HOSTNAME" ]]; then
        IS_VALID=true; break
    fi
    if [[ "$ENTRY" == "*"* ]]; then
        DOMAIN_SUFFIX=$(echo "$ENTRY" | sed 's/\*//')
        if [[ "$TARGET_HOSTNAME" == *"$DOMAIN_SUFFIX" ]]; then
            DOTS_IN_TARGET=$(echo "$TARGET_HOSTNAME" | tr -cd '.' | wc -c)
            DOTS_IN_SUFFIX=$(echo "$DOMAIN_SUFFIX" | tr -cd '.' | wc -c)
            if [ "$DOTS_IN_TARGET" -eq "$DOTS_IN_SUFFIX" ]; then
                IS_VALID=true; break
            fi
        fi
    fi
done

if [ "$IS_VALID" = false ]; then
    echo -e "${RED}[WARNING] Certificate does not seem to cover $TARGET_HOSTNAME${NC}"
    read -p "Do you want to ignore this and force install? (y/n): " CONFIRM
    [[ ! $CONFIRM =~ ^[Yy]$ ]] && exit 1
fi

# --- Step 5: Copy & Hardening ---
echo -e "${BLUE}[INFO] Syncing certificates to node storage...${NC}"
$SUDO mkdir -p "$NODE_CERT_DIR"
$SUDO cp "${LOCAL_CERT_DIR}/${CA_CHAIN}" "$NODE_CERT_DIR/"
$SUDO cp "${LOCAL_CERT_DIR}/${MASTER_CERT}" "$NODE_CERT_DIR/"
$SUDO cp "${LOCAL_CERT_DIR}/${MASTER_KEY}" "$NODE_CERT_DIR/"

$SUDO chown root:root "$NODE_CERT_DIR"/*
$SUDO chmod 644 "${NODE_CERT_DIR}/${CA_CHAIN}"
$SUDO chmod 644 "${NODE_CERT_DIR}/${MASTER_CERT}"
$SUDO chmod 600 "${NODE_CERT_DIR}/${MASTER_KEY}"

# --- Step 6: Import into Conjur ---
echo -e "${BLUE}[INFO] Importing into Conjur container...${NC}"
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke ca import --no-restart --root --force "${CONTAINER_CERT_DIR}/${CA_CHAIN}"
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke ca import --no-restart --key "${CONTAINER_CERT_DIR}/${MASTER_KEY}" --set "${CONTAINER_CERT_DIR}/${MASTER_CERT}"

# --- Step 7: Restart & Health Check ---
echo -e "${BLUE}[INFO] Restarting services to apply new certificates...${NC}"
$SUDO $CONTAINER_MGR exec "$NODE_NAME" sv restart conjur nginx pg seed

echo -e "${CYAN}--- Final Verification ---${NC}"
sleep 5
HEALTH_CHECK=$(curl -k -s "https://localhost:$CONJUR_HTTPS_PORT/health" | jq -r '.ok')

if [ "$HEALTH_CHECK" == "true" ]; then
    echo -e "${GREEN}[SUCCESS] Conjur is healthy with new certificates.${NC}"
    
    # --- Step 8: AUTO CLEANUP ---
    echo -e "${YELLOW}[SECURITY] Cleaning up PEM files from node storage...${NC}"
    $SUDO rm -f "${NODE_CERT_DIR}/${CA_CHAIN}"
    $SUDO rm -f "${NODE_CERT_DIR}/${MASTER_CERT}"
    $SUDO rm -f "${NODE_CERT_DIR}/${MASTER_KEY}"
    
    echo -e "${GREEN}[DONE] Local PEM files removed from ${NODE_CERT_DIR}.${NC}"
else
    echo -e "${RED}[ERROR] Health check failed. Keeping PEM files for troubleshooting.${NC}"
    exit 1
fi

echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN}  Step 05 Finished: Certificates applied and cleaned.   ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 06.gen.standby.seed.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Generate seeds for Standby nodes. Includes Primary-only check.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 06: Generating Seeds for Standby Cluster ---${NC}"

# --- Step 1: Guard Clause - Check if Node is Primary ---
# Seed generation is a Leader-specific task. 
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This node is configured as '${NODE_TYPE}'.${NC}"
    echo -e "${RED}[ERROR] Seed generation MUST only be executed on the PRIMARY (Leader) node.${NC}"
    echo -e "${YELLOW}[TIP] Please check NODE_TYPE in 00.config.sh or run this on the Leader VM.${NC}"
    exit 1
fi

echo -e "${GREEN}[PROCEED] Node is confirmed as PRIMARY. Preparing seed files...${NC}"

# --- Step 2: Internal Logic Calculations ---
# Paths are derived from the NODE_NAME and directory structure
NODE_DATA_DIR="/opt/cyberark/${NODE_NAME}"
SEED_STORAGE_DIR="${NODE_DATA_DIR}/seeds"

# Ensure the seeds directory exists on the host
$SUDO mkdir -p "$SEED_STORAGE_DIR"

echo -e "${BLUE}[INFO]${NC} Primary Node identified: ${NODE_NAME}"
echo -e "${BLUE}[INFO]${NC} Target Seeds Directory : ${SEED_STORAGE_DIR}"

# --- Step 3: Execute Seed Generation ---
# Iterate through the standby nodes defined in the config array
for STANDBY in "${STANDBY_NODES[@]}"; do
    # Calculate FQDN for each Standby node
    STANDBY_FQDN="${STANDBY}.${CONJUR_DOMAIN}"
    TARGET_FILE="${SEED_STORAGE_DIR}/${STANDBY}.tar.gz"
    
    echo -ne "${CYAN}[PROCESS]${NC} Generating seed for ${STANDBY_FQDN}... "
    
    # Execute evoke command inside the Leader container
    # The output is redirected to the mapped seeds volume
    $SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke seed standby "$STANDBY_FQDN" > "$TARGET_FILE"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}DONE${NC}"
        echo -e "          -> File created: ${TARGET_FILE}"
    else
        echo -e "${RED}FAILED${NC}"
        exit 1
    fi
done

# --- Final Summary ---
echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN} Step 06 Finished: All seeds are ready for distribution. ${NC}"
echo -e "${BLUE} [NEXT STEP]: Transfer these files to your Standby VMs: ${NC}"
for STANDBY in "${STANDBY_NODES[@]}"; do
    echo -e "   - ${STANDBY}.tar.gz"
done
echo -e "${CYAN}========================================================${NC}"---
FILE 07.distribute.seeds.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Automated Seed distribution with Host Trust (keyscan) and Connectivity checks.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 07: Seed Distribution & Cluster Trust ---${NC}"

# --- 1. Guard Clause: Only Primary node can distribute seeds ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This node is configured as '${NODE_TYPE}'.${NC}"
    echo -e "${RED}[ERROR] Script 07 MUST only be executed on the PRIMARY node.${NC}"
    exit 1
fi

# --- 2. Environment Setup ---
SSH_USER="root"
NODE_DATA_DIR="/opt/cyberark/${NODE_NAME}"
SEED_STORAGE_DIR="${NODE_DATA_DIR}/seeds"
KNOWN_HOSTS_FILE="$HOME/.ssh/known_hosts"

# Ensure .ssh directory exists locally
mkdir -p "$HOME/.ssh" && chmod 700 "$HOME/.ssh"

# --- 3. Automated Host Trust (ssh-keyscan) ---
# This prevents the "Are you sure you want to continue connecting (yes/no)?" prompt
echo -e "${CYAN}[PROCESS]${NC} Pre-trusting Standby nodes in known_hosts..."

for i in "${!STANDBY_NODES[@]}"; do
    S_NAME="${STANDBY_NODES[$i]}"
    S_IP="${STANDBY_IPS[$i]}"
    S_FQDN="${S_NAME}.${CONJUR_DOMAIN}"

    echo -ne "${BLUE}[INFO]${NC} Scanning keys for ${S_FQDN} (${S_IP})... "
    # Remove existing entries to avoid conflicts, then add new ones
    ssh-keygen -R "$S_NAME" &> /dev/null
    ssh-keygen -R "$S_IP" &> /dev/null
    ssh-keygen -R "$S_FQDN" &> /dev/null
    
    ssh-keyscan -H "$S_NAME","$S_IP","$S_FQDN" >> "$KNOWN_HOSTS_FILE" 2>/dev/null
    echo -e "${GREEN}DONE${NC}"
done

# --- 4. Connectivity and Distribution Loop ---
for i in "${!STANDBY_NODES[@]}"; do
    S_NAME="${STANDBY_NODES[$i]}"
    S_IP="${STANDBY_IPS[$i]}"
    S_FQDN="${S_NAME}.${CONJUR_DOMAIN}"
    
    TARGET_FILE="${SEED_STORAGE_DIR}/${S_NAME}.tar.gz"
    REMOTE_PATH="/opt/cyberark/${S_NAME}/seeds/"

    echo -e "${CYAN}--------------------------------------------------------${NC}"
    echo -e "${BLUE}[TARGET]${NC} Processing Node: ${S_FQDN}"

    # 4.1. Ping Check
    echo -ne "${BLUE}[CHECK]${NC} Network latency test... "
    if ! ping -c 1 -W 2 "$S_IP" &> /dev/null; then
        echo -e "${RED}FAILED${NC}"
        echo -e "${YELLOW}[WARN] Cannot reach ${S_IP}. Is the VM running?${NC}"
        continue
    fi
    echo -e "${GREEN}OK${NC}"

    # 4.2. SSH Authentication Check
    # BatchMode=yes ensures the command fails immediately if keys are not set up
    echo -ne "${BLUE}[CHECK]${NC} SSH Key Authentication... "
    ssh -o BatchMode=yes -o ConnectTimeout=5 "${SSH_USER}@${S_FQDN}" "exit" &> /dev/null
    if [ $? -ne 0 ]; then
        echo -e "${RED}DENIED${NC}"
        echo -e "${YELLOW}[ACTION] SSH Keys not found on remote. Run:${NC}"
        echo -e "         ssh-copy-id ${SSH_USER}@${S_FQDN}"
        exit 1
    fi
    echo -e "${GREEN}GRANTED${NC}"

    # 4.3. Seed File Check
    if [ ! -f "$TARGET_FILE" ]; then
        echo -e "${RED}[ERROR] Seed file not found: ${TARGET_FILE}${NC}"
        continue
    fi

    # 4.4. Transfer Execution
    echo -e "${BLUE}[INFO]${NC} Transferring seed to ${S_FQDN}..."
    # Ensure remote directory exists
    ssh "${SSH_USER}@${S_FQDN}" "mkdir -p ${REMOTE_PATH}"
    
    # Transfer the file
    scp "$TARGET_FILE" "${SSH_USER}@${S_FQDN}:${REMOTE_PATH}"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[SUCCESS]${NC} Seed file successfully pushed to ${S_FQDN}"
    else
        echo -e "${RED}[ERROR]${NC} Failed to transfer file to ${S_FQDN}"
        exit 1
    fi
done

echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN} Step 07 Finished: Distribution complete.               ${NC}"
echo -e "${BLUE} [NEXT STEP]: Login to Standbys and run Script 08.      ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 08.config.conjur.standby.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Join Conjur cluster using the explicit --leader-address flag.

# --- Source Global Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 08: Join Cluster as Standby ---${NC}"

# --- 1. Path Definitions ---
# The seed file pushed by Script 07
HOST_SEED_PATH="/opt/cyberark/${NODE_NAME}/seeds/${NODE_NAME}.tar.gz"
# The path as seen from inside the container volume mount
CONTAINER_SEED_PATH="/opt/cyberark/conjur/seeds/${NODE_NAME}.tar.gz"
# The FQDN of your Primary node
LEADER_FQDN="${PRIMARY_NODE}.${CONJUR_DOMAIN}"

# --- 2. Unpack Seed ---
echo -e "${BLUE}[INFO]${NC} Unpacking seed file for ${NODE_NAME}..."
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke unpack seed "$CONTAINER_SEED_PATH"

if [ $? -ne 0 ]; then
    echo -e "${RED}[ERROR] Failed to unpack seed. Check if the file exists.${NC}"
    exit 1
fi

# --- 3. Configure Standby (The Clean Way) ---
# Using the discovered --leader-address flag to point directly to the Primary FQDN
echo -e "${BLUE}[INFO]${NC} Connecting to Leader at ${LEADER_FQDN}..."
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke configure standby --leader-address="$LEADER_FQDN"

# --- 4. Final Cleanup & Status ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Node '${NODE_NAME}' is now a Standby in the cluster!${NC}"
    # Security: Remove the host seed file after successful configuration
    $SUDO rm -f "$HOST_SEED_PATH"
else
    echo -e "${RED}[ERROR] Standby configuration failed. See logs above.${NC}"
    exit 1
fi

echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN} Step 08 Finished: Cluster replication established.     ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 00.config.example.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 26, 2025
# Description: Global environment configuration.

# --- Configuration Status ---
READY=false

# --- Container Environment Setting ---
SUDO=
CONTAINER_MGR=podman

# --- Conjur Network Configuration ---
CONJUR_DOMAIN=poc.local
CONJUR_HTTPS_PORT=443

# --- Node Role Configuration ---
NODE_TYPE="primary" # "primary" or "standby" or "follower"
NODE_NAME=cjl100062

# --- Cluster Nodes Configuration ---
PRIMARY_NODE=cjl100062
PRIMARY_IP=172.16.100.62
STANDBY_NODES=("cjl100063" "cjl100064")
STANDBY_IPS=("172.16.100.63" "172.16.100.64")

# --- Follower Nodes Configuration ---
FOLLOWER_NODES=("cjf100066" "cjf100067")
FOLLOWER_IPS=("172.16.100.66" "172.16.100.67")

# --- Conjur Identity & Access Management ---
CONJUR_ADMIN_PW="ChangeMe123!!" 
CONJUR_ACCOUNT=POC 

# --- Versioning and Image Paths ---
UPLOAD_DIR=/opt/upload
CONJUR_APPLIANCE_FILE=conjur-appliance-Rls-v13.7.0.tar.gz
CONJUR_VERSION=13.7.0

# --- Configuration Header ---
# --- ANSI Color Codes for Professional Output ---
BLUE='\033[0;34m'; GREEN='\033[0;32m'; RED='\033[0;31m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'
echo -e "${CYAN}========================================================${NC}"
echo -e "${CYAN}      CyberArk Secrets Manager - Self-Hosted v${CONJUR_VERSION}${NC}"
echo -e "${CYAN}      Author: Huy Do (huy.do@cyberark.com)${NC}"
echo -e "${CYAN}========================================================${NC}"
echo -e "${BLUE}[INFO]${NC} Node Name    : ${NODE_NAME}"
if [[ "$NODE_TYPE" == "primary" ]]; then
    echo -e "${BLUE}[INFO]${NC} Standby Nodes : ${STANDBY_NODES[*]}"
fi---
FILE 00.config.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 26, 2025
# Description: Global environment configuration.

# --- Configuration Status ---
READY=true

# --- Container Environment Setting ---
SUDO=
CONTAINER_MGR=podman

# --- Conjur Network Configuration ---
CONJUR_DOMAIN=poc.local
CONJUR_HTTPS_PORT=443

# --- Node Role Configuration ---
NODE_TYPE="primary" # "primary" or "standby" or "follower"
NODE_NAME=cjl100062

# --- Cluster Nodes Configuration ---
PRIMARY_NODE=cjl100062
PRIMARY_IP=172.16.100.62
STANDBY_NODES=("cjl100063" "cjl100064")
STANDBY_IPS=("172.16.100.63" "172.16.100.64")

# --- Follower Nodes Configuration ---
FOLLOWER_NODES=("cjf100066" "cjf100067")
FOLLOWER_IPS=("172.16.100.66" "172.16.100.67")

# --- Conjur Identity & Access Management ---
CONJUR_ADMIN_PW="ChangeMe123!!" 
CONJUR_ACCOUNT=POC 

# --- Versioning and Image Paths ---
UPLOAD_DIR=/opt/upload
CONJUR_APPLIANCE_FILE=conjur-appliance-Rls-v13.7.0.tar.gz
CONJUR_VERSION=13.7.0

# --- Configuration Header ---
# --- ANSI Color Codes for Professional Output ---
BLUE='\033[0;34m'; GREEN='\033[0;32m'; RED='\033[0;31m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'
echo -e "${CYAN}========================================================${NC}"
echo -e "${CYAN}      CyberArk Secrets Manager - Self-Hosted v${CONJUR_VERSION}${NC}"
echo -e "${CYAN}      Author: Huy Do (huy.do@cyberark.com)${NC}"
echo -e "${CYAN}========================================================${NC}"
echo -e "${BLUE}[INFO]${NC} Node Name    : ${NODE_NAME}"
if [[ "$NODE_TYPE" == "primary" ]]; then
    echo -e "${BLUE}[INFO]${NC} Standby Nodes : ${STANDBY_NODES[*]}"
fi---
FILE 01.common.check.env.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Full environment readiness, dependency installation, and Smart Host Sync.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready in 00.config.sh. Set READY=true.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 01: Full Environment & Host Readiness Check ---${NC}"

# --- 1. Check Required Conjur Image File ---
FULL_IMAGE_PATH="${UPLOAD_DIR}/${CONJUR_APPLIANCE_FILE}"
echo -ne "${CYAN}[CHECK]${NC} Checking for Conjur image file... "

if [ -f "$FULL_IMAGE_PATH" ]; then
    echo -e "${GREEN}Found${NC}"
else
    echo -e "${RED}Not Found${NC}"
    echo -e "${YELLOW}[TIP] Please upload ${CONJUR_APPLIANCE_FILE} to ${UPLOAD_DIR}${NC}"
    exit 1
fi

# --- 2. OS Detection and Package Manager Setup ---
if [ -x "$(command -v dnf)" ]; then
    PKG_MANAGER="dnf"
    INSTALL_CMD="dnf install -y"
    # Enable EPEL for RHEL-based systems (required for 'pv')
    if [ -f /etc/redhat-release ]; then
        echo -e "${BLUE}[INFO]${NC} RHEL system detected. Ensuring EPEL repository is enabled..."
        $SUDO $INSTALL_CMD https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E %rhel).noarch.rpm &> /dev/null
    fi
elif [ -x "$(command -v apt-get)" ]; then
    PKG_MANAGER="apt-get"
    INSTALL_CMD="apt-get install -y"
else
    echo -e "${RED}[ERROR] No supported package manager (dnf/apt) found.${NC}"
    exit 1
fi

# --- 3. Define and Install Required Packages ---
REQUIRED_PKGS=("jq" "curl" "openssl" "ca-certificates" "pv")

for PKG in "${REQUIRED_PKGS[@]}"; do
    echo -ne "${CYAN}[CHECK]${NC} Checking for ${PKG}... "
    if command -v "$PKG" &> /dev/null; then
        echo -e "${GREEN}Installed${NC}"
    else
        echo -e "${YELLOW}Missing. Installing...${NC}"
        $SUDO $INSTALL_CMD "$PKG" &> /dev/null
        if [ $? -ne 0 ]; then
            echo -e "${RED}[ERROR] Failed to install ${PKG}.${NC}"
            exit 1
        fi
    fi
done

# --- 4. Container Manager Check & Installation ---
echo -ne "${CYAN}[CHECK]${NC} Checking for ${CONTAINER_MGR}... "
if command -v "$CONTAINER_MGR" &> /dev/null; then
    echo -e "${GREEN}Found${NC}"
else
    echo -e "${YELLOW}Not Found. Attempting to install ${CONTAINER_MGR}...${NC}"
    if [[ "$CONTAINER_MGR" == "podman" ]]; then
        $SUDO $INSTALL_CMD podman &> /dev/null
    elif [[ "$CONTAINER_MGR" == "docker" ]]; then
        [[ "$PKG_MANAGER" == "apt-get" ]] && $SUDO $INSTALL_CMD docker.io &> /dev/null || $SUDO $INSTALL_CMD docker &> /dev/null
    fi
    
    if command -v "$CONTAINER_MGR" &> /dev/null; then
        echo -e "${GREEN}[SUCCESS] ${CONTAINER_MGR} installed.${NC}"
    else
        echo -e "${RED}[ERROR] Failed to install ${CONTAINER_MGR}.${NC}"
        exit 1
    fi
fi

# --- 5. SMART HOST UPDATE LOGIC ---
echo -e "${CYAN}[PROCESS]${NC} Synchronizing /etc/hosts with cluster configuration..."

# Helper Function: add_or_update_host_entry <IP> <HOSTNAME>
add_or_update_host_entry() {
    local IP=$1
    local NAME=$2
    local FQDN="${NAME}.${CONJUR_DOMAIN}"
    local NEW_ENTRY="${IP}  ${NAME}  ${FQDN}"
    
    # Check if the EXACT line already exists
    if grep -Fxq "$NEW_ENTRY" /etc/hosts; then
        echo -e "${GREEN}[OK]${NC} Host entry for ${FQDN} is already correct."
    else
        # If the FQDN exists but with different data, remove it
        if grep -q "$FQDN" /etc/hosts; then
            echo -e "${YELLOW}[UPDATE]${NC} Outdated or incorrect entry found for ${FQDN}. Updating..."
            $SUDO sed -i "/$FQDN/d" /etc/hosts
        else
            echo -e "${BLUE}[INFO]${NC} Adding new entry for ${FQDN}..."
        fi
        
        # Append the new correct entry
        echo "$NEW_ENTRY" | $SUDO tee -a /etc/hosts > /dev/null
    fi
}

# 5.1 Sync Primary Node
if [ -n "$PRIMARY_IP" ] && [ -n "$PRIMARY_NODE" ]; then
    add_or_update_host_entry "$PRIMARY_IP" "$PRIMARY_NODE"
else
    echo -e "${RED}[ERROR] PRIMARY_IP or PRIMARY_NODE is undefined in 00.config.sh${NC}"
    exit 1
fi

# 5.2 Sync Standby Nodes from Array
for i in "${!STANDBY_NODES[@]}"; do
    S_NAME="${STANDBY_NODES[$i]}"
    S_IP="${STANDBY_IPS[$i]}"
    if [ -n "$S_IP" ] && [ -n "$S_NAME" ]; then
        add_or_update_host_entry "$S_IP" "$S_NAME"
    fi
done

# --- Final Verification ---
echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN}  Step 01 Finished: Env, Software, and Hosts are READY. ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 02.common.load.img.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 26, 2025

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 02: Load Conjur Image with Progress Bar ---${NC}"

FULL_IMAGE_PATH="${UPLOAD_DIR}/${CONJUR_APPLIANCE_FILE}"

# --- Check if pv is installed ---
if ! command -v pv &> /dev/null; then
    echo -e "${YELLOW}[WARN] 'pv' not found. Loading without progress bar...${NC}"
    $SUDO $CONTAINER_MGR load -i "$FULL_IMAGE_PATH"
else
    echo -e "${BLUE}[INFO] Loading Conjur appliance image...${NC}"
    pv "$FULL_IMAGE_PATH" | $SUDO $CONTAINER_MGR load
fi

# --- Verification ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Conjur image loaded successfully.${NC}"
else
    echo -e "${RED}[ERROR] Failed to load the image.${NC}"
    exit 1
fi

$SUDO $CONTAINER_MGR images | grep -i "conjur"---
FILE 03.common.start.conjur.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Unified script to start Conjur Appliance for both Primary and Standby.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 03: Initialize Unified Conjur Appliance Container ---${NC}"
echo -e "${BLUE}[INFO]${NC} Deploying as: ${NODE_TYPE}"

# --- Step 1: Auto-Detect Correct Image Name ---
echo -ne "${CYAN}[CHECK]${NC} Detecting Conjur image for version ${CONJUR_VERSION}... "
DETECTED_IMAGE=$($SUDO $CONTAINER_MGR images --format "{{.Repository}}:{{.Tag}}" | grep ":${CONJUR_VERSION}" | cut -d':' -f1 | head -n1)

if [ -z "$DETECTED_IMAGE" ]; then
    echo -e "${RED}Not Found!${NC}"
    exit 1
else
    FULL_IMAGE_TAG="${DETECTED_IMAGE}:${CONJUR_VERSION}"
    echo -e "${GREEN}Found: ${FULL_IMAGE_TAG}${NC}"
fi

# --- Step 2: Cleanup Existing Container ---
echo -e "${BLUE}[INFO] Cleaning up existing container: ${NODE_NAME}...${NC}"
$SUDO $CONTAINER_MGR stop "$NODE_NAME" &> /dev/null
$SUDO $CONTAINER_MGR rm -f "$NODE_NAME" &> /dev/null

# --- Step 3: Prepare Node-Specific Host Directories ---
# Using identical structure for all nodes to support promotion
NODE_DATA_DIR="/opt/cyberark/$NODE_NAME"
echo -e "${BLUE}[INFO] Preparing persistent volumes in ${NODE_DATA_DIR}...${NC}"

$SUDO mkdir -p "${NODE_DATA_DIR}"/{security,config,backups,seeds,logs,certs}
$SUDO chmod o+x "${NODE_DATA_DIR}/config"

# --- Step 4: Execute Container Run (Unified Ports) ---
# We map ALL ports (including 1999) on all nodes so Standbys are ready for promotion.
echo -e "${BLUE}[INFO] Starting Conjur container...${NC}"

$SUDO $CONTAINER_MGR run \
    --name "$NODE_NAME" \
    --detach \
    --restart=unless-stopped \
    --security-opt seccomp=unconfined \
    --publish "$CONJUR_HTTPS_PORT:443" \
    --publish "444:444" \
    --publish "5432:5432" \
    --publish "1999:1999" \
    --cap-add AUDIT_WRITE \
    --volume "${NODE_DATA_DIR}/config:/etc/conjur/config:Z" \
    --volume "${NODE_DATA_DIR}/security:/opt/cyberark/conjur/security:Z" \
    --volume "${NODE_DATA_DIR}/backups:/opt/conjur/backup:Z" \
    --volume "${NODE_DATA_DIR}/seeds:/opt/cyberark/conjur/seeds:Z" \
    --volume "${NODE_DATA_DIR}/logs:/var/log/conjur:Z" \
    --volume "${NODE_DATA_DIR}/certs:/opt/cyberark/conjur/certs:Z" \
    "$FULL_IMAGE_TAG"

# --- Step 5: Final Verification ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Conjur container '${NODE_NAME}' is running.${NC}"
    echo -e "${BLUE}[INFO] Node is ready for 'evoke configure leader' OR 'evoke unpack seed'.${NC}"
else
    echo -e "${RED}[ERROR] Failed to start Conjur container.${NC}"
    exit 1
fi

echo -e "${CYAN}--- Container Status ---${NC}"
$SUDO $CONTAINER_MGR ps | grep "$NODE_NAME"---
FILE 04.leader.activation.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Configure Conjur Leader. Includes Primary-only check.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

# --- Check if Configuration is Ready ---
if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready. Set READY=true in 00.config.sh${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 04: Configure Conjur Leader ---${NC}"

# --- Step 1: Guard Clause - Check if Node is Primary ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This node is configured as '${NODE_TYPE}'.${NC}"
    echo -e "${RED}[ERROR] Script 04 MUST only be executed on the PRIMARY (Leader) node.${NC}"
    echo -e "${YELLOW}[TIP] Standby nodes do not run this. They join via another script.${NC}"
    exit 1
fi

echo -e "${GREEN}[PROCEED] Node is confirmed as PRIMARY. Starting configuration...${NC}"

# --- Step 2: Prepare Configuration Variables ---
LEADER_CONTAINER=$NODE_NAME
CLUSTER_DNS="conjur-leader.${CONJUR_DOMAIN}" 
NODE_FQDN="${NODE_NAME}.${CONJUR_DOMAIN}"    
STANDBY_FQDNS_LIST=$(printf ",%s.${CONJUR_DOMAIN}" "${STANDBY_NODES[@]}")
ALL_ALT_NAMES="${CLUSTER_DNS},${NODE_FQDN}${STANDBY_FQDNS_LIST}"

echo -e "${BLUE}[INFO]${NC} Leader Container : ${LEADER_CONTAINER}"
echo -e "${BLUE}[INFO]${NC} Cluster DNS      : ${CLUSTER_DNS}"
echo -e "${BLUE}[INFO]${NC} Node FQDN        : ${NODE_FQDN}"
echo -e "${BLUE}[INFO]${NC} Standby          : ${STANDBY_FQDNS_LIST}"

# --- Step 3: Execute Evoke Configure Leader ---
echo -e "${BLUE}[INFO] Running 'evoke configure leader' inside container...${NC}"

$SUDO $CONTAINER_MGR exec "$LEADER_CONTAINER" evoke configure leader \
    --accept-eula \
    --hostname "$CLUSTER_DNS" \
    --leader-altnames "${ALL_ALT_NAMES}" \
    --admin-password "$CONJUR_ADMIN_PW" \
    "$CONJUR_ACCOUNT"

# --- Step 4: Verification ---
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Conjur Leader has been configured successfully.${NC}"
else
    echo -e "${RED}[ERROR] Configuration failed. Check container logs.${NC}"
    exit 1
fi

# --- Step 5: Final Health Check ---
echo -e "${CYAN}--- Verifying Leader Health Endpoint ---${NC}"
sleep 5
curl -k -s "https://localhost:$CONJUR_HTTPS_PORT/health" | jq || echo -e "${YELLOW}[WARN] Could not reach health endpoint yet.${NC}"

echo -e "${CYAN}========================================================${NC}"
echo -e "${GREEN}  Step 04 Finished: Leader is ready for usage.          ${NC}"
echo -e "${YELLOW}  Web UI: https://${CLUSTER_DNS}:${CONJUR_HTTPS_PORT}/ui ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 05.leader.import.certs.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 31, 2025
# Description: Import 3rd Party Certificates for Leader and Followers. 
# Strategy: Set HTTPS for Leader (--set) and pre-load Follower identities into the store.

# --- Source Configuration ---
if [ -f "./00.config.sh" ]; then
    source ./00.config.sh
else
    echo -e "\033[0;31m[ERROR] 00.config.sh not found!\033[0m"
    exit 1
fi

# --- Check if Configuration is Ready ---
if [ "$READY" = false ]; then
    echo -e "${RED}[ERROR] Configuration is not ready. Set READY=true in 00.config.sh${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 05: Import 3rd Party Certificates ---${NC}"

# --- Step 1: Guard Clause - Check if Node is Primary ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This node is configured as '${NODE_TYPE}'.${NC}"
    echo -e "${RED}[ERROR] Script 05 MUST only be executed on the PRIMARY (Leader) node.${NC}"
    exit 1
fi

echo -e "${GREEN}[PROCEED] Node is confirmed as PRIMARY. Starting certificate import...${NC}"

# --- Step 2: Define Paths & Targets ---
LOCAL_CERT_DIR="./certs"
CA_CHAIN="ca-chain.pem"
MASTER_KEY="master-key.pem"
MASTER_CERT="master-cert.pem"

NODE_DATA_DIR="/opt/cyberark/$NODE_NAME"
NODE_CERT_DIR="${NODE_DATA_DIR}/certs"
CONTAINER_CERT_DIR="/opt/cyberark/conjur/certs"

# Target Hostname calculation for Leader
TARGET_HOSTNAME="conjur-leader.${CONJUR_DOMAIN}"

# --- Step 3: Mandatory File Existence Check (Leader) ---
for FILE in "$CA_CHAIN" "$MASTER_KEY" "$MASTER_CERT"; do
    if [ ! -f "${LOCAL_CERT_DIR}/$FILE" ]; then
        echo -e "${RED}[ERROR] Mandatory Leader file not found: ${LOCAL_CERT_DIR}/$FILE${NC}"
        exit 1
    fi
done

# --- Step 4: Validate Leader Certificate SAN/CN ---
echo -e "${BLUE}[INFO] Validating if Leader cert covers: ${TARGET_HOSTNAME}...${NC}"
CERT_DNS_LIST=$(openssl x509 -in "${LOCAL_CERT_DIR}/${MASTER_CERT}" -text -noout | grep -oP 'DNS:[^, ]+' | sed 's/DNS://g')
CERT_CN=$(openssl x509 -in "${LOCAL_CERT_DIR}/${MASTER_CERT}" -noout -subject | sed -n 's/.*CN[ ]*=[ ]*\([^,]*\).*/\1/p')

ALL_ENTRIES="$CERT_CN $CERT_DNS_LIST"
IS_VALID=false

for ENTRY in $ALL_ENTRIES; do
    if [[ "$ENTRY" == "$TARGET_HOSTNAME" ]]; then
        IS_VALID=true; break
    fi
done

if [ "$IS_VALID" = false ]; then
    echo -e "${RED}[WARNING] Certificate does not explicitly list $TARGET_HOSTNAME${NC}"
    read -p "Do you want to ignore this and force install? (y/n): " CONFIRM
    [[ ! $CONFIRM =~ ^[Yy]$ ]] && exit 1
fi

# --- Step 5: Copy All Certs to Node Storage ---
echo -e "${BLUE}[INFO] Syncing all certificates to node storage...${NC}"
$SUDO mkdir -p "$NODE_CERT_DIR"
$SUDO cp "${LOCAL_CERT_DIR}"/*.pem "$NODE_CERT_DIR/"
$SUDO chown root:root "$NODE_CERT_DIR"/*
$SUDO chmod 644 "${NODE_CERT_DIR}"/*

# --- Step 6: Import into Conjur ---
echo -e "${BLUE}[INFO] Importing certificates into Conjur container...${NC}"

# 6.1 Import Root CA
echo "  -> Importing Root CA Chain..."
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke ca import --no-restart --root --force "${CONTAINER_CERT_DIR}/${CA_CHAIN}"

# 6.2 Import and Set Leader HTTPS Certificate
echo "  -> Setting Leader HTTPS Identity..."
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke ca import --no-restart \
    --key "${CONTAINER_CERT_DIR}/${MASTER_KEY}" \
    --set \
    "${CONTAINER_CERT_DIR}/${MASTER_CERT}"

# 6.3 Import Follower Certificates (Looping through directory)
echo "  -> Pre-loading Follower Identities into Store..."
for CERT_PATH in "${LOCAL_CERT_DIR}"/follower-*-cert.pem; do
    [ -e "$CERT_PATH" ] || continue # Handle case where no follower certs exist
    
    FILE_NAME=$(basename "$CERT_PATH")
    # Identify corresponding key file (replace -cert.pem with -key.pem)
    KEY_FILE_NAME="${FILE_NAME/-cert.pem/-key.pem}"
    
    if [ -f "${LOCAL_CERT_DIR}/$KEY_FILE_NAME" ]; then
        echo "     - Found: $FILE_NAME"
        $SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke ca import --no-restart \
            --key "${CONTAINER_CERT_DIR}/$KEY_FILE_NAME" \
            "${CONTAINER_CERT_DIR}/$FILE_NAME"
    else
        echo -e "${YELLOW}     [SKIP] Key missing for $FILE_NAME${NC}"
    fi
done

# --- Step 7: Restart & Health Check ---
echo -e "${BLUE}[INFO] Restarting services to apply new certificates...${NC}"
$SUDO $CONTAINER_MGR exec "$NODE_NAME" sv restart conjur nginx pg seed

echo -e "${CYAN}--- Final Verification ---${NC}"
sleep 10
HEALTH_CHECK=$(curl -k -s "https://localhost:$CONJUR_HTTPS_PORT/health" | jq -r '.ok')

if [ "$HEALTH_CHECK" == "true" ]; then
    echo -e "${GREEN}[SUCCESS] Leader is healthy with 3rd party certificates.${NC}"
    
    # --- Step 8: Security Cleanup ---
    echo -e "${YELLOW}[SECURITY] Cleaning up PEM files from node storage...${NC}"
    $SUDO rm -f "${NODE_CERT_DIR}"/*.pem
else
    echo -e "${RED}[ERROR] Health check failed. Check logs: $CONTAINER_MGR logs $NODE_NAME${NC}"
    exit 1
fi

echo -e "${CYAN}========================================================${NC}"---
FILE 06.standby.activation.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 30, 2025
# Description: Step 06 - Activate Standby nodes from Primary Leader.
# Strategy: Binary clean seed generation and explicit remote error reporting.

if [ -f "./00.config.sh" ]; then source ./00.config.sh; else exit 1; fi

# --- Guard Clause ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This script must only be executed on the PRIMARY node.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 06: Standby Activation Process ---${NC}"

SSH_USER="root"
PRIMARY_FQDN="${PRIMARY_NODE}.${CONJUR_DOMAIN}"

for i in "${!STANDBY_NODES[@]}"; do
    S_NAME="${STANDBY_NODES[$i]}"
    S_FQDN="${S_NAME}.${CONJUR_DOMAIN}"
    SEED_FILE="/tmp/${S_NAME}_seed.tar.gz"

    echo -e "\n${BLUE}========================================================${NC}"
    echo -e " TARGET STANDBY: ${S_FQDN}"
    echo -e "${BLUE}========================================================${NC}"

    # 1. CHECK READINESS & ROLE
    echo -ne "  -> Checking connectivity & node role... "
    # Check if the host is reachable and the container is in 'blank' state
    if ! ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=3 "${SSH_USER}@${S_FQDN}" "$CONTAINER_MGR exec ${S_NAME} evoke role show" | grep -q "blank"; then
        echo -e "${RED}NOT BLANK OR UNREACHABLE${NC} (Skipping)"
        continue
    fi
    echo -e "${GREEN}READY${NC}"

    # 2. GENERATE STANDBY SEED
    echo -ne "  -> Generating Standby Seed (Binary Clean)... "
    # Ensure binary integrity by redirecting stderr to dev/null
    $CONTAINER_MGR exec "${PRIMARY_NODE}" evoke seed standby "${S_FQDN}" "${PRIMARY_FQDN}" 1> "${SEED_FILE}" 2>/dev/null
    
    if [[ ! -s "${SEED_FILE}" ]]; then
        echo -e "${RED}FAILED to generate seed file!${NC}"
        continue
    fi
    echo -e "${GREEN}DONE${NC}"

    # 3. TRANSFER SEED TO STANDBY HOST
    echo -ne "  -> Transferring Seed to remote host... "
    scp -q -o StrictHostKeyChecking=no "${SEED_FILE}" "${SSH_USER}@${S_FQDN}:/tmp/"
    if [ $? -eq 0 ]; then echo -e "${GREEN}SUCCESS${NC}"; else echo -e "${RED}FAILED${NC}"; continue; fi

    # 4. REMOTE ACTIVATION (FIXED HOSTNAME VARIABLE)
    echo -e "  -> Triggering remote activation..."
    ssh -o StrictHostKeyChecking=no "${SSH_USER}@${S_FQDN}" "bash -s" << EOF
        set -e
        # Copy seed from host into the appliance container
        echo "     - Loading seed into container..."
        ${CONTAINER_MGR} cp /tmp/${S_NAME}_seed.tar.gz ${S_NAME}:/tmp/seed.tar.gz
        
        echo "     - Unpacking standby seed..."
        ${CONTAINER_MGR} exec ${S_NAME} evoke unpack seed /tmp/seed.tar.gz 2>&1
        
        echo "     - Configuring standby role..."
        ${CONTAINER_MGR} exec ${S_NAME} evoke configure standby 2>&1
        
        # Local cleanup on the remote host
        rm -f /tmp/${S_NAME}_seed.tar.gz
EOF

    if [ $? -eq 0 ]; then
        echo -e "  -> ${GREEN}SUCCESS:${NC} Standby ${S_NAME} is active."
    else
        echo -e "  -> ${RED}ERROR:${NC} Activation failed for ${S_NAME}."
    fi

    # Local cleanup on the Leader machine
    rm -f "${SEED_FILE}"
done

echo -e "\n${CYAN}========================================================${NC}"
echo -e "${GREEN} Step 06 Complete: Standby nodes provisioned.            ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 07.followers.activation.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 30, 2025
# Description: Step 12 - Activate Followers using Leader's Internal CA.
# Strategy: Standard seed generation, DB whitelisting, and robust activation.

if [ -f "./00.config.sh" ]; then source ./00.config.sh; else exit 1; fi

# --- Guard Clause ---
# Ensure this script only runs on the Primary (Leader) node
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This script must only be executed on the PRIMARY node.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Starting Step 12: Follower Activation (Internal CA Mode) ---${NC}"

SSH_USER="root"
PRIMARY_FQDN="${PRIMARY_NODE}.${CONJUR_DOMAIN}"

for i in "${!FOLLOWER_NODES[@]}"; do
    F_NAME="${FOLLOWER_NODES[$i]}"
    F_FQDN="${F_NAME}.${CONJUR_DOMAIN}"
    SEED_FILE="/tmp/${F_NAME}_seed.tar.gz"

    echo -e "\n${BLUE}========================================================${NC}"
    echo -e " TARGET FOLLOWER: ${F_FQDN}"
    echo -e "${BLUE}========================================================${NC}"

    # 1. CHECK READINESS & ROLE
    echo -ne "  -> Checking readiness & node role... "
    # Verify SSH connectivity and ensure the remote appliance is in 'blank' state
    if ! ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=3 "${SSH_USER}@${F_FQDN}" "$CONTAINER_MGR exec ${F_NAME} evoke role show" | grep -q "blank"; then
        echo -e "${RED}NOT BLANK OR UNREACHABLE${NC} (Skipping)"
        continue
    fi
    echo -e "${GREEN}READY${NC}"

    # 2. GENERATE SEED (Using Master Internal CA)
    echo -ne "  -> Generating Seed ... "
    # Redirect stderr (2) to /dev/null to prevent WARN logs from corrupting the binary tarball (stdout)
    $CONTAINER_MGR exec "${PRIMARY_NODE}" evoke seed follower --replication-set full "${F_FQDN}" "${PRIMARY_FQDN}" 1> "${SEED_FILE}"
    
    if [[ ! -s "${SEED_FILE}" ]]; then
        echo -e "${RED}FAILED${NC}"
        continue
    fi
    echo -e "${GREEN}DONE${NC}"

    # 3. TRANSFER SEED TO FOLLOWER
    echo -ne "  -> Transferring Seed... "
    scp -q -o StrictHostKeyChecking=no "${SEED_FILE}" "${SSH_USER}@${F_FQDN}:/tmp/"
    echo -e "${GREEN}SUCCESS${NC}"

    # 4. ACTIVATE FOLLOWER
    echo -e "  -> Triggering remote activation (Unpack & Configure)..."
    ssh -o StrictHostKeyChecking=no "${SSH_USER}@${F_FQDN}" "bash -s" << EOF
        set -e
        # Copy seed from host into the appliance container
        ${CONTAINER_MGR} cp /tmp/${F_NAME}_seed.tar.gz ${F_NAME}:/tmp/seed.tar.gz
        
        echo "     - Unpacking seed identity..."
        ${CONTAINER_MGR} exec ${F_NAME} evoke unpack seed /tmp/seed.tar.gz
        
        echo "     - Configuring follower (Connecting to $PRIMARY_FQDN)..."
        # Note: --force-new-id may be required if reconfiguring a previously used node
        ${CONTAINER_MGR} exec ${F_NAME} evoke configure follower
        
        # Cleanup temporary seed on remote host
        rm -f /tmp/${F_NAME}_seed.tar.gz
EOF

    if [ $? -eq 0 ]; then
        echo -e "  -> ${GREEN}SUCCESS:${NC} Follower ${F_NAME} is now active and replicating."
    else
        echo -e "  -> ${RED}ERROR:${NC} Activation failed. Check Follower container logs."
    fi

    # Cleanup local seed file on Leader
    rm -f "${SEED_FILE}"
done

echo -e "\n${CYAN}========================================================${NC}"
echo -e "${GREEN} Step 12 Complete: Followers successfully provisioned.   ${NC}"
echo -e "${CYAN}========================================================${NC}"---
FILE 08.activate.sync.sh
---
#!/bin/bash
# Author: Huy Do (huy.do@cyberark.com)
# Date: December 30, 2025
# Description: Step 09 - Activate Sync Replication and Verify Cluster Health (v13.7).

if [ -f "./00.config.sh" ]; then source ./00.config.sh; else exit 1; fi

# --- 1. Guard Clause ---
if [[ "$NODE_TYPE" != "primary" ]]; then
    echo -e "${RED}[ERROR] This script must only be executed on the PRIMARY (Leader) node.${NC}"
    exit 1
fi

echo -e "${YELLOW}--- Phase 1: Activating Synchronous Replication ---${NC}"

# According to v13.7 documentation: 'evoke replication sync start'
# We use --force to bypass the 2-standby recommendation check for lab environments.
echo -e "${BLUE}[INFO]${NC} Executing: evoke replication sync start --force"
$SUDO $CONTAINER_MGR exec "$NODE_NAME" evoke replication sync start --force

if [ $? -eq 0 ]; then
    echo -e "${GREEN}[SUCCESS] Synchronous mode activated.${NC}"
else
    echo -e "${RED}[ERROR] Failed to activate sync mode. Ensure Standbys are connected.${NC}"
    exit 1
fi

# Give the cluster a moment to stabilize replication threads
echo -e "${BLUE}[INFO]${NC} Waiting 5 seconds for replication stabilization..."
sleep 5

echo -e "${YELLOW}--- Phase 2: Verifying Cluster Health & Sync State ---${NC}"

# 2. Fetch raw health data from the API
RAW_HEALTH=$(curl -k -s "https://localhost:$CONJUR_HTTPS_PORT/health")

if [ -z "$RAW_HEALTH" ]; then
    echo -e "${RED}[ERROR] Could not reach Conjur Health API.${NC}"
    exit 1
fi

# 3. Extract Core Identity and Status
ROLE=$(echo "$RAW_HEALTH" | jq -r '.database.replication_status.role // .database.role')
OK_STATUS=$(echo "$RAW_HEALTH" | jq -r '.ok')

echo -e "--------------------------------------------------------"
echo -e "  Node Name : ${NODE_NAME}"
echo -e "  API Role  : ${CYAN}${ROLE^^}${NC}"
echo -e "  Health    : $([[ "$OK_STATUS" == "true" ]] && echo -e "${GREEN}OK" || echo -e "${RED}ERROR")${NC}"
echo -e "--------------------------------------------------------"

# 4. Display Replication Statistics
echo -e "${CYAN}[REPLICATION DASHBOARD]${NC}"
REPLICATION_JSON=$(echo "$RAW_HEALTH" | jq '.database.replication_status.pg_stat_replication')

if [[ "$REPLICATION_JSON" == "null" || "$REPLICATION_JSON" == "[]" ]]; then
    echo -e "${YELLOW}[WARN] No Standby nodes detected.${NC}"
    echo -e "Tip: Ensure Script 08 (with 'sync enable') was run on Standbys."
else
    # Professional Table Header
    printf "${WHITE}%-20s %-15s %-15s %-10s${NC}\n" "HOSTNAME" "IP ADDRESS" "DB STATE" "SYNC MODE"
    echo "--------------------------------------------------------"
    
    echo "$REPLICATION_JSON" | jq -c '.[]' | while read -r item; do
        NAME=$(echo "$item" | jq -r '.application_name')
        IP=$(echo "$item" | jq -r '.client_addr')
        STATE=$(echo "$item" | jq -r '.state')
        SYNC=$(echo "$item" | jq -r '.sync_state')
        
        # Color coding: Green for streaming/sync, Yellow for others
        COLOR=$GREEN
        [[ "$SYNC" != "sync" && "$SYNC" != "quorum" ]] && COLOR=$YELLOW
        
        printf "${COLOR}%-20s %-15s %-15s %-10s${NC}\n" "$NAME" "$IP" "$STATE" "$SYNC"
    done
fi

echo -e "========================================================"
echo -e "${GREEN} Deployment and Synchronization Check Complete.         ${NC}"
echo -e "========================================================"---
